<!DOCTYPE html>
<html>
  <head>
    <style>
      body {
        min-height: 475px;
        font-size: 110%;
        overflow-y: scroll;
        color: #ffffff;
        background-color: black;
        margin: 0;
        position: relative; /* Needed for the pseudo-element */
        padding-bottom: 100px;
      }
      body::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        /* border: 5px solid rgb(0, 70, 94); */
        border-top: 5px solid rgb(0, 70, 94);
        border-left: 5px solid rgb(0, 70, 94);
        border-right: 5px solid rgb(0, 70, 94);
        pointer-events: none;
        z-index: 1000;
      }
      .content-wrapper {
        padding: 10px; /* Adjust this value as needed */
      }

      #title {
        font-size: 200%;
        font-weight: 400;
        color: #0000ff;
        text-align: center;
      }
      #description {
        font-size: 100%;
        min-height: 70px;
        color: #ffffff;
      }
      form {
        display: flex;
        width: 95%;
        flex-direction: column;
        align-items: stretch;
      }
      p {
        margin: 0;
        display: flex;
        align-items: center;
        flex-direction: row;
      }
      label {
        text-align: right;
        padding: 5px;
        font-size: 110%;
        min-height: 25px;
        width: 120px;
      }
      input,
      textarea,
      button {
        padding: 5px;
        font-size: 110%;
        min-height: 25px;
        flex: 2;
      }
      input[type="checkbox"] {
        width: 36px;
        max-width: 36px;
        margin: 0px -1px -1px 0px;
        min-height: 36px;
      }
      textarea {
        min-height: 100px;
      }
      .bottom-container {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        display: flex;
        justify-content: space-between;
        padding: 5px;
        background-color: rgb(0, 70, 94);
        z-index: 1002;
      }
      .bottom-div {
        display: inline-block;
        background-color: rgb(0, 70, 94);
        position: relative;
        bottom: 0;
      }
      .bottom-div span {
        display: block;
        padding: 5px 20px;
        line-height: 0.8;
      }
      .bottom-div:first-child span {
        padding-left: 5px;
      }
      .bottom-div:last-child span {
        padding-right: 20px;
      }
      .debug-message {
        color: yellow;
      }
      form#footer {
        flex-direction: row;
        position: fixed; /* Make footer always visible */
        bottom: 0px; /* Adjust distance from bottom */
        left: 5px;
        right: 5px;
        display: flex;
        justify-content: space-evenly; /* Evenly space the buttons */
        padding: 5px 10px 40px 10px; /* Padding: top right bottom left */
        z-index: 1001; /* Ensure it's above the pseudo-element */
        background-color: rgba(0, 71, 94, 0.359);
      }
    </style>
    <!-- #region meta -->
    <meta name="color-scheme" content="only light">
    <meta
      name="autotoolswebscreen"
      type="variablejs"
      group="UI Info"
      id="titleFromTasker"
      label="Title"
      description="Title to show at the top."
      hint="YouTube"
    />
    <meta
      name="autotoolswebscreen"
      type="variablejs"
      group="UI Info"
      id="descriptionFromTasker"
      label="Description"
      description="(optional) Description to show at the top."
      hint="Description of the video."
    />
    <meta
      name="autotoolswebscreen"
      type="variablejs"
      group="UI Info"
      id="fieldsFromTasker"
      label="Form fields"
      description="A list of fields to show in the web screen. Comma separated."
      hint="Text:TEXT,Bool:BOOL,Int:INT"
    />
    <meta
      name="autotoolswebscreen"
      type="variablejs"
      group="UI Info"
      id="placeholdersFromTasker"
      label="Form Placeholders"
      description="Placeholders for the form fields. Comma separated."
      hint="value1,true,3"
    />
    <meta
      name="autotoolswebscreen"
      type="variablejs"
      group="UI Info"
      id="valuesFromTasker"
      label="Form Values"
      description="Values to prefill the form with. Comma separated."
      hint="value1,true,3"
    />
    <meta
      name="autotoolswebscreen"
      type="variablejs"
      group="UI Info"
      id="enableDebug"
      label="Enable Debugging"
      description="Should enable debugInfo"
      hint="true or null"
    />
    <!-- #endregion meta -->
  </head>
  <body>
    <div class="content-wrapper">
      <!-- All your content except .bottom-container goes here -->
      <div id="title">Untitled 20</div>
      <div id="description"></div>
      <div id="debugInfo" class="debug-message"></div>
      <div id="header"></div>
      <form id="content"></form>
      <form id="footer"></form>
      <div id="bottom-container" class="bottom-container">
        <div class="bottom-div"><span id="highlight"></span></div>
        <div class="bottom-div">
          <span id="version">Input Form Version Not Updated</span>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      AutoTools.sendCommand("InputOpened");
      var br = document.createElement("span");
      br.innerHTML = "<br>";
      var titleElement = document.querySelector("#title");
      var descriptionElement = document.querySelector("#description");
      var headerElement = document.querySelector("#header");
      var contentElement = document.querySelector("#content");
      var footerElement = document.querySelector("#footer");
      var highlightElement = document.querySelector("#highlight");
      var versionElement = document.querySelector("#version");
      var debugInfoElement = document.querySelector("#debugInfo");

      const originalConsoleLog = console.log;
      console.log = function (...message) {
        originalConsoleLog(...message);
        appendDebugInfo(...message);
      };

      function appendDebugInfo(...messages) {
        if (AutoTools.isSet("enableDebug")) {
          if (enableDebug !== "%debug") {
            messages.forEach((message) => {
              debugInfoElement.innerHTML += message + "<br>"; // Append new messages and keep old ones
            });
          }
        }
      }

      function isError(input) {
        return input instanceof Error
      }

      console.log("Debugging Enabled");
      if (AutoTools.isSet("titleFromTasker")) {
        if (titleFromTasker !== "%title") {
          titleElement.innerHTML = titleFromTasker;
          document.title = titleFromTasker;
        }else{
          console.log("Title not set")
        }
      }
      if (AutoTools.isSet("descriptionFromTasker")) {
        if (descriptionFromTasker !== "%description") {
          descriptionElement.innerHTML = descriptionFromTasker.replace(
            /\n/g,
            "<br>"
          );
        }else{
          console.log("Description not set")
        }
      }
      if (AutoTools.isSet("fieldsFromTasker")) {
        if(fieldsFromTasker !== "%fields"){
          // Content from tasker is an array separated by commas
          var items = fieldsFromTasker.split(/(?<!\\),/);
          items.forEach(function (item) {
            // Separate the string into name and type
            var [name, type] = item.split(/(?<!\\):/);
            // contentElement.appendChild(br.cloneNode(true));
            // Create a <p> element for each item
            var pElement = document.createElement("p");
            var labelElement = document.createElement("label");
            labelElement.innerHTML = name + ":";
            pElement.appendChild(labelElement);
            if (type === "TEXTAREA") {
              var inputElement = document.createElement("textarea");
            } else {
              var inputElement = document.createElement("input");
            }
            switch (type) {
              case "TEXTAREA":
                // Create a <div> element for TEXT type
                inputElement.rows = 10;
                inputElement.cols = 50;
                inputElement.wrap = "soft";
                // inputElement.style = "height: 200px; width: 100%;";
                break;
              case "TEXT":
                // Create a <div> element for TEXT type
                inputElement.type = "text";
                break;
              case "BOOL":
                // Create a <div> element for BOOL type
                inputElement.type = "checkbox";
                break;
              case "INT":
                // Create a <div> element for INT type
                inputElement.type = "number";
                break;
              case "REAL":
                // Create a <div> element for REAL type
                inputElement.type = "number";
                inputElement.step = "0.01";
                break;
              default:
                // Handle unknown type
                inputElement.type = "text";
                inputElement.placeholder = "Unknown type: " + type;
                console.log("Unknown type: " + type);
                break;
            }
            inputElement.id = name;
            inputElement.name = name;
            pElement.appendChild(inputElement);
            contentElement.appendChild(pElement);
          });

          // Create Submit Button
          var submitButton = document.createElement("input");
          submitButton.type = "button";
          submitButton.value = "Submit";
          submitButton.style = "max-width: 100px;";
          submitButton.onclick = function () {
            var data = [];
            var outputs = {};
            items.forEach(function (item) {
              var [name, type] = item.split(/(?<!\\):/);
              var inputElement = document.getElementById(name);
              if (inputElement.type === "checkbox") {
                data.push(inputElement.checked);
                outputs[name] = inputElement.checked;
              }
              if (inputElement.type === "number") {
                data.push(inputElement.value);
                outputs[name] = inputElement.value;
              }
              if (
                inputElement.type === "text" ||
                inputElement.type === "textarea"
              ) {
                data.push(inputElement.value.replace(/;/g, "\\;"));
                outputs[name] = inputElement.value.replace(/;/g, "\\;");
              }
            });
            data = data.join(";");
            outputs = JSON.stringify(outputs);
            // AutoTools.sendCommand("InputValues=:=" + data);
            AutoTools.sendCommand("InputJSON=:=" + outputs);
            AutoTools.sendCommand("InputCompleted");
          };
          footerElement.appendChild(submitButton);

          // Create Cancel Button
          var cancelButton = document.createElement("input");
          cancelButton.type = "button";
          cancelButton.value = "Cancel";
          cancelButton.style = "max-width: 100px;";
          cancelButton.onclick = function () {
            AutoTools.sendCommand("InputCancelled");
          };
          footerElement.appendChild(cancelButton);
        }else{
          console.log("Fields not set")
        }
      }
      // Prefill the form with values from tasker
      if (AutoTools.isSet("valuesFromTasker")) {
        var placeholders = placeholdersFromTasker.split(/(?<!\\),/);
        var values = valuesFromTasker.split(/(?<!\\),/);
        var items = fieldsFromTasker.split(/(?<!\\),/);
        var validValueCount = 0;
        var invalidValueCount = 0;
        console.log("Got to Here: 1")

        // console.log("Values: " + values.join(",").replace(/\\(.)/g, "$1")); // Display values
        // console.log("Items: " + items.join(",")); // Display items

        items.forEach((item, index) => {
          console.log("Got to Here (recursive): 1")
          var [name, type] = item.split(/(?<!\\):/);
          var inputElement = document.getElementById(name);
          // Display the current item and value being processed
          try {
            console.log("Processing: " + name + ":" + type + " with value " + (values[index].replace(/\\(.)/g, "$1") instanceof Error ? values[index] : values[index].replace(/\\(.)/g, "$1")));
          } catch (error) {
            console.log("Error: " + error);
          }
          //HACK: Reprocessed
          console.log("Got to Here (recursive): 1a")
          if (!inputElement) {
            console.log("Element not found: " + name); // Display if element not found
            return;
          }
          console.log("Got to Here (recursive): 1b")
          if (
            typeof values[index] === "undefined" ||
            values[index].replace(/\\(.)/g, "$1") === "%values"
          ) {
            console.log("Got to Here (recursive): 1b1 (undefined)")
            invalidValueCount++;
          } else {
            console.log("Got to Here (recursive): 1b1 (valid)")
            validValueCount++;
            if (inputElement.type === "checkbox") {
              inputElement.checked =
                values[index].replace(/\\(.)/g, "$1") === "true";
            } else {
              inputElement.value = values[index].replace(/\\(.)/g, "$1");
            }
          }
          console.log("Got to Here (recursive): 2")
        });
        console.log("Got to Here: 2")
        if (invalidValueCount > 0) {
          console.log("Has " + invalidValueCount + " Invalid Values");
        } else if (validValueCount > 0) {
          console.log("Has " + validValueCount + " Valid Values");
        }
        console.log("Got to Here: 3")
      }else{
        console.log("Values not set")
      }
      versionElement.innerHTML = "Input Form Version: 2.0.9";
      highlightElement.innerHTML = "More Logging; Great!";
    </script>
  </body>
</html>
